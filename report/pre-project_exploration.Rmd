---
title: "CS&E Pre-Project Exploration"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
    html_notebook:
        code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)

dirr::get_rds("../data/tidy")
```

## Exploration

```{r}
orders_lab <- orders_valid %>%
    filter(request == FALSE) 

total_orders <- sum(!orders_requests$req_completed, nrow(orders_lab))
collected_orders <- sum(!is.na(orders_lab$Collected))
uncollected_orders <- sum(is.na(orders_lab$Collected))
uncollected_requests <- sum(!orders_requests$req_completed)
total_uncollected <- uncollected_orders + uncollected_requests
timely90 <- sum(orders_lab$timely90, na.rm = TRUE)
timely60 <- sum(orders_lab$timely60, na.rm = TRUE)
timely30 <- sum(orders_lab$timely30, na.rm = TRUE)
untimely <- sum(!orders_lab$timely60, na.rm = TRUE)
```

### Requests
* Levels ordered by request: `r nrow(orders_requests)`  
    - Excludes automatic requests generated by Discern Advisor
* Requests collected: `r sum(orders_requests$req_completed)` (`r round(sum(orders_requests$req_completed) / nrow(orders_requests) * 100, 2)`%)

### Levels

- Total orders placed (includes lab requests): `r total_orders`
- Actual levels ordered: `r nrow(orders_lab)` (`r round(nrow(orders_lab) / total_orders * 100, 2)`%) 
    + Includes requests that were converted to lab orders
    + Excludes cancelled and duplicate orders
- Levels drawn: `r sum(!is.na(orders_lab$Collected))` (`r round(sum(!is.na(orders_lab$Collected)) / total_orders * 100, 2)`%)  
- Levels drawn within 90 minutes of scheduled time: `r timely90` (`r round(timely90 / collected_orders * 100, 2)`%)
    + Percent of labs actually drawn
- Levels drawn within 60 minutes of scheduled time: `r timely60` (`r round(timely60 / collected_orders * 100, 2)`%)
- Levels drawn within 30 minutes of scheduled time: `r timely30` (`r round(timely30 / collected_orders * 100, 2)`%)

### Assessment

- Requests not collected: `r uncollected_requests` (`r round(uncollected_requests / nrow(orders_requests) * 100,2)`%)
- Levels and requests not drawn: `r total_uncollected` / `r total_orders` (`r round(total_uncollected / total_orders * 100, 2)`%)
- Inappropriately collected: `r total_uncollected + untimely` / `r total_orders` (`r round((total_uncollected + untimely) / total_orders * 100, 2)`%)
    + Not drawn
    + Greater than 60 minutes from scheduled time

### Timing

Distribution of difference between desired draw time and actual draw time.

```{r}
mn <- mean(orders_lab$collect_detail_diff, na.rm = TRUE)
std <- sd(orders_lab$collect_detail_diff, na.rm = TRUE)

ggplot(orders_lab, aes(x = collect_detail_diff)) +
    geom_density() +
    geom_vline(xintercept = mn, color = "blue") +
    geom_vline(xintercept = mn + c(1, -1) * std, color = "red") +
    geom_vline(xintercept = c(-60, 60), color = "darkgreen", linetype = "dashed")
# coord_cartesian(xlim = c(-200, 200))
```

Remove extreme outliers

```{r}
q <- quantile(orders_lab$collect_detail_diff, na.rm = TRUE, probs = c(0.25, 0.5, 0.75))
iqr <- IQR(orders_lab$collect_detail_diff, na.rm = TRUE)

no_outliers <- orders_lab %>%
    filter(!is.na(collect_detail_diff),
           collect_detail_diff >= q[1] - (iqr * 3),
           collect_detail_diff <= (iqr * 3) + q[3])

mn <- mean(no_outliers$collect_detail_diff, na.rm = TRUE)
std <- sd(no_outliers$collect_detail_diff, na.rm = TRUE)

ggplot(no_outliers, aes(x = collect_detail_diff)) +
    geom_density() +
    geom_vline(xintercept = mn, color = "blue") +
    geom_vline(xintercept = mn + c(1, -1) * std, color = "red") +
    geom_vline(xintercept = c(-60, 60), color = "darkgreen", linetype = "dashed")
```

Relationship between how far in advance the level was ordered, and how close to desired draw time the level was actually drawn.

```{r}
orders_valid %>%
    filter(!is.na(sched_diff),
           !is.na(collect_detail_diff)) %>%
    ggplot(aes(x = as.numeric(sched_diff), y = as.numeric(collect_detail_diff))) +
    geom_point(aes(color = shift), alpha = 0.6) +
    scale_x_continuous(breaks = seq(0, 96, 12)) +
    ggtitle("Time from order to draw vs. time to actual draw") +
    xlab("Time from ordering to desired draw (hours)") +
    ylab("Time from desired draw to actual draw (minutes)")
```

Among levels not drawn, how far in advance of due time was level ordered

```{r}
orders_lab %>%
    bind_rows(orders_requests) %>%
    filter(!is.na(sched_diff),
           is.na(collect_detail_diff) | !req_completed) %>%
    ggplot(aes(x = shift, y = sched_diff)) +
    geom_boxplot()
```


## By Shift

```{r}
ggplot(orders_lab, aes(x = shift)) +
    geom_bar() +
    ggtitle("Number of Levels per Shift")
```

Distribution by shift

```{r}
orders_lab %>%
    filter(!is.na(shift)) %>%
    ggplot(aes(x = collect_detail_diff)) +
    geom_density() +
    facet_wrap(~ shift)
```

## Time Differences

Time (in minutes) between when levels was ordered to be drawn and when it was actually drawn.

```{r}
summary(as.numeric(orders_lab$collect_detail_diff))
```

### Day Shift
```{r}
summary(as.numeric(orders_lab[orders_lab$shift == "day", ]$collect_detail_diff))
```

### Night Shift
```{r}
summary(as.numeric(orders_lab[orders_lab$shift == "night", ]$collect_detail_diff))
```

```{r}
ggplot(orders_lab, aes(x = shift, y = as.numeric(collect_detail_diff))) +
    geom_boxplot()
```

```{r}
t.test(collect_detail_diff ~ shift, orders_lab)
```

## Labs Not Collected

### Early AM

```{r}
orders_lab %>%
    filter(freq == "Early AM" | is.na(freq)) %>%
    mutate(drawn = !is.na(Collected)) %>%
    group_by(drawn) %>%
    count()
```

## Discoveries

* There are automatic vancomycin requests created by a Discern Advisor
    - Unclear where this is generated from
    - Request detail was usually several days prior to the order date
* Levels ordered without a frequency (mostly Early AM) show up with and Ordered date/time instead of a Scheduled date/time
    - Those that show as Ordered do not get Dispatched
        + Majority of these were never collected
* Most levels not drawn seem to be either entered as a lab request or as Early AM / missing frequency
