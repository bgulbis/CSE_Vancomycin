---
title: "CS&E Pre-Project Exploration"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
    html_notebook:
        code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(stringr)
library(lubridate)
library(tableone)

dirr::get_rds("../data/tidy")

hvi <- c("HH CVICU", "HH CVIMU", "HH HFIC", "HH HFIM", "HH 5HVI", "HH CCU", "HVI CIMU")

orders_levels <- full_join(levels, orders_valid, by = c("pie.id", "order.id")) %>%
    filter(event.unit %in% hvi | (is.na(event.unit) & order.unit %in% hvi),
           request == FALSE) 

collected <- orders_levels %>%
    filter(!is.na(Collected)) %>%
    group_by(event.unit) %>%
    summarize(collected = n(),
              timely = sum(timely60, na.rm = TRUE)) 

not_done <- orders_levels %>%
    filter(is.na(Collected),
           is.na(lab.result)) %>%
    group_by(order.unit) %>%
    count %>%
    rename(not_done = n)

requests <- orders_requests %>%
    group_by(order.unit) %>%
    count %>%
    rename(requests = n) %>%
    filter(order.unit %in% hvi)

totals_units <- left_join(collected, not_done, by = c("event.unit" = "order.unit")) %>%
    left_join(requests, by = c("event.unit" = "order.unit")) %>%
    mutate(percent_timely = timely / collected,
           total = collected + not_done,
           percent_not_done = not_done / total,
           percent_appropriate = timely / total)

totals_hvi <- totals_units %>%
    ungroup() %>%
    summarize_at(vars(collected, timely, not_done, requests, total), funs(sum), na.rm = TRUE) %>%
    mutate(event.unit = "HVI",
           percent_timely = timely / collected,
           percent_not_done = not_done / total,
           percent_appropriate = timely / total) 

totals <- bind_rows(totals_units, totals_hvi) %>%
    select(event.unit, num_levels = total, everything())

```

## Result Summary

```{r}
knitr::kable(totals)
```

## Exploration

```{r}
orders_lab <- orders_valid %>%
    filter(request == FALSE) 

df <- orders_lab %>%
    group_by(order.unit) %>%
    summarize_at(c("timely90", "timely60", "timely30"), funs(sum), na.rm = TRUE)

```

```{r results='asis'}
vars <- c("timely90", "timely60", "timely30", "collect_detail_diff", "freq", "priority", "request", "shift")
tbl_hvi <- CreateTableOne(vars, data = orders_levels)
tbl_units <- CreateTableOne(vars, "event.unit", orders_levels)
ptbl_hvi <- print(tbl_hvi, printToggle = FALSE)
ptbl_units <- print(tbl_units, printToggle = FALSE)
rownames(ptbl_hvi) <- str_replace_all(rownames(ptbl_hvi), "   ", "- ")
total <- cbind(ptbl_hvi, ptbl_units)
knitr::kable(total)
```

### Timing

Distribution of difference between desired draw time and actual draw time.

```{r}
mn <- mean(orders_lab$collect_detail_diff, na.rm = TRUE)
std <- sd(orders_lab$collect_detail_diff, na.rm = TRUE)

ggplot(orders_lab, aes(x = collect_detail_diff)) +
    geom_density() +
    geom_vline(xintercept = mn, color = "blue") +
    geom_vline(xintercept = mn + c(1, -1) * std, color = "red") +
    geom_vline(xintercept = c(-60, 60), color = "darkgreen", linetype = "dashed")
# coord_cartesian(xlim = c(-200, 200))
```

Remove extreme outliers

```{r}
q <- quantile(orders_lab$collect_detail_diff, na.rm = TRUE, probs = c(0.25, 0.5, 0.75))
iqr <- IQR(orders_lab$collect_detail_diff, na.rm = TRUE)

no_outliers <- orders_lab %>%
    filter(!is.na(collect_detail_diff),
           collect_detail_diff >= q[1] - (iqr * 3),
           collect_detail_diff <= (iqr * 3) + q[3])

mn <- mean(no_outliers$collect_detail_diff, na.rm = TRUE)
std <- sd(no_outliers$collect_detail_diff, na.rm = TRUE)

ggplot(no_outliers, aes(x = collect_detail_diff)) +
    geom_density() +
    geom_vline(xintercept = mn, color = "blue") +
    geom_vline(xintercept = mn + c(1, -1) * std, color = "red") +
    geom_vline(xintercept = c(-60, 60), color = "darkgreen", linetype = "dashed")
```

Relationship between how far in advance the level was ordered, and how close to desired draw time the level was actually drawn.

```{r}
orders_valid %>%
    filter(!is.na(sched_diff),
           !is.na(collect_detail_diff)) %>%
    ggplot(aes(x = as.numeric(sched_diff), y = as.numeric(collect_detail_diff))) +
    geom_point(aes(color = shift), alpha = 0.6) +
    scale_x_continuous(breaks = seq(0, 96, 12)) +
    ggtitle("Time from order to draw vs. time to actual draw") +
    xlab("Time from ordering to desired draw (hours)") +
    ylab("Time from desired draw to actual draw (minutes)")
```

Among levels not drawn, how far in advance of due time was level ordered

#### HVI
```{r}
df <- orders_levels %>%
    filter(is.na(Collected),
           is.na(lab.result)) %>%
    mutate(sched_diff = as.numeric(difftime(detail.datetime, order.datetime, units = "hours"))) %>%
    ggplot(aes(x = shift, y = sched_diff)) +
    geom_boxplot() +
    ylab("Time prior to collection (hours)")

df
```

#### By Unit
```{r}
df +
    facet_wrap(~ order.unit)
```


## By Shift

#### HVI
```{r}
df <- ggplot(orders_levels, aes(x = shift)) +
    geom_bar() +
    ggtitle("Number of Levels per Shift")

df
```

#### By Unit
```{r}
df +
    facet_wrap(~ event.unit)
```

Distribution by shift

```{r}
orders_lab %>%
    filter(!is.na(shift)) %>%
    ggplot(aes(x = collect_detail_diff)) +
    geom_density() +
    facet_wrap(~ shift)
```

## Time Differences

Time (in minutes) between when levels was ordered to be drawn and when it was actually drawn.

#### HVI

```{r}
summary(as.numeric(orders_lab$collect_detail_diff))
```

### Day Shift
```{r}
summary(as.numeric(orders_lab[orders_lab$shift == "day", ]$collect_detail_diff))
```

### Night Shift
```{r}
summary(as.numeric(orders_lab[orders_lab$shift == "night", ]$collect_detail_diff))
```

```{r}
g <- ggplot(orders_levels, aes(x = shift, y = as.numeric(collect_detail_diff))) +
    geom_boxplot()
g
```

Zoom in on data

```{r}
g +
    coord_cartesian(ylim = c(-250, 250))
```


```{r}
t.test(collect_detail_diff ~ shift, orders_lab)
```

#### By Unit

```{r}
g +
    facet_wrap(~ event.unit) +
    coord_cartesian(ylim = c(-250, 250))

```


## Discoveries

* There are automatic vancomycin requests created by a Discern Advisor
    - Unclear where this is generated from
    - Request detail was usually several days prior to the order date
* Levels ordered as Early AM generate a child order with a scheduled time of 0300 the following day
    - The parent Early AM order was removed from this analysis due to an invalid scheduled collection time
