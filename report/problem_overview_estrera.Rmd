---
title: "Appropriate Vancomycin Level Collection in CVICU"
subtitle: "CS&E Project"
author: "Brian Gulbis, PharmD, BCPS"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: pdflatex
link-citations: yes
---

```{r setup, include=FALSE}
library(tufte)
# invalidate cache when the tufte version changes
knitr::opts_chunk$set(tidy = FALSE, echo = FALSE, cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)
```

```{r, message=FALSE}
library(tidyverse)
library(stringr)
library(forcats)
library(lubridate)
library(tableone)

x <- dirr::get_rds("../data/tidy")

hvi <- c("HH CVICU", "HH CVIMU", "HH HFIC", "HH HFIM", "HH 5HVI", "HH CCU", "HVI CIMU")

orders_levels <- full_join(vanc_levels, orders_valid, by = c("pie.id", "order.id")) %>%
    filter(event.unit %in% hvi | (is.na(event.unit) & order.unit %in% hvi)) %>%
    mutate(uncollected = is.na(Collected) & is.na(lab.result),
           location = coalesce(event.unit, order.unit),
           month = floor_date(detail.datetime, unit = "month"),
           day = wday(detail.datetime, label = TRUE, abbr = FALSE),
           hour = hour(detail.datetime),
           exceed_2hr = abs(collect_detail_diff) > 120) %>%
    dmap_at(c("timely120", "timely60", "appropriate"), ~ coalesce(.x, FALSE))

collected <- orders_levels %>%
    filter(!is.na(Collected)) %>%
    group_by(event.unit) %>%
    summarize(collected = n(),
              timely = sum(appropriate, na.rm = TRUE),
              early = sum(early, na.rm = TRUE),
              late = sum(late, na.rm = TRUE),
              late_2hr = sum(exceed_2hr, na.rm = TRUE)) 

not_done <- orders_levels %>%
    filter(is.na(Collected),
           is.na(lab.result)) %>%
    group_by(order.unit) %>%
    count %>%
    rename(not_done = n)

requests <- orders_requests %>%
    group_by(order.unit) %>%
    count %>%
    rename(requests = n) %>%
    filter(order.unit %in% hvi)

early_am <- orders_early_am %>%
    group_by(order.unit) %>%
    count() %>%
    rename(early_am = n) %>%
    filter(order.unit %in% hvi) 

totals_units <- left_join(collected, not_done, by = c("event.unit" = "order.unit")) %>%
    left_join(requests, by = c("event.unit" = "order.unit")) %>%
    mutate(total = collected + not_done,
           defects = total - timely,
           percent_not_done = not_done / total * 100,
           percent_appropriate = timely / total * 100,
           percent_exceed_2hr = late_2hr / total * 100)

totals_hvi <- totals_units %>%
    ungroup() %>%
    summarize_at(vars(collected, timely, early, late, late_2hr, not_done, requests, total, defects), funs(sum), na.rm = TRUE) %>%
    mutate(event.unit = "HVI",
           percent_not_done = not_done / total * 100,
           percent_appropriate = timely / total * 100,
           percent_exceed_2hr = late_2hr / total * 100) 

totals <- bind_rows(totals_units, totals_hvi) %>%
    select(event.unit, num_levels = total, everything()) %>%
    filter(!is.na(event.unit))

cvicu <- orders_levels %>%
    filter(location == "HH CVICU",
           month != "2016-03-01",
           month != "2017-01-01") 
```

# Problem Overview

`r newthought('In CVICU')`, approximately 40% of vancomycin levels are being collected inappropriately,^[Defined as being collected more than 60 minutes from the scheduled collection time, or more than 120 minutes for Early AM levels] and this rate has been increasing from April to December 2016.   


Inappropriately drawn levels lead to inaccurate dosing and treatment decisions, which may result in undertreating infections, increased antimicrobial resistance, and increased risk of adverse effects.  

```{r, fig.cap="Appropriately Collected Vancomycin Levels", fig.margin=TRUE}
hvi_avg_appropriate <- totals$percent_appropriate[totals$event.unit == "HVI"]

totals %>%
    filter(event.unit != "HVI") %>%
    rename(appropriate = percent_appropriate) %>%
    ggplot(aes(x = event.unit, y = appropriate)) +
    geom_bar(aes(fill = event.unit == "HH CVICU"), stat = "identity", position = "dodge") +
    geom_hline(yintercept = hvi_avg_appropriate, linetype = "dashed") +
    xlab("Unit") +
    ylab("Levels (%)") +
    coord_cartesian(ylim = c(0, 100)) +
    scale_fill_brewer(palette = "Paired") +
    theme_bw() +
    theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, fig.cap="Inappropriately Collected and Uncollected Levels in CVICU", fig.margin=TRUE}
cvicu %>%
    group_by(month) %>%
    summarize(appropriate = 100 - (sum(appropriate) / n() * 100),
              uncollected = sum(uncollected) / n() * 100) %>%
    gather(key, value, appropriate, uncollected) %>%
    ggplot(aes(x = month, y = value)) +
    geom_line(aes(color = key), size = 2) + 
    geom_smooth(aes(linetype = key), color = "black", method = "lm", size = 0.5) +
    xlab("Month") +
    ylab("Levels (%)") +
    # coord_cartesian(ylim = c(0, 100)) +
    scale_color_brewer(palette = "Paired", labels = c("Inappropriate", "Uncollected"), guide = guide_legend(title = NULL)) +
    scale_linetype_discrete(guide = FALSE) +
    scale_x_datetime(date_labels = "%b", date_breaks = "1 month") +
    theme_bw() +
    theme(legend.position = "bottom")
```
# Aim Statement

Increase appropriately collected vancomycin levels in CVICU from 66% to 80% by April 2017

# Project Scope

* Patients on vancomcyin in CVICU
* Excludes any patients without vancomycin levels (i.e., those on post-operative prophylaxis)
* Will not assess appropriateness of order or vancomycin dosing

# Financial Implications

A vancomycin level drawn after the scheduled time could actually be supratherapeutic, potentially resulting in nephrotoxicity if the dose is not properly adjusted. Vancomycin-induced nephrotoxicity has been associated with a 46% increase in length of stay and a 17% increase in hospital cost.^[Stevens V, et al. Cost and Length of Stay Associated with Vancomycin-Induced Nephrotoxicity (Abstract). Proceedings from: ISPOR 16th Annual European Congress and 4th Latin America Conference 2013] ^[Bamgbola O. Ther Adv Endocrinol Metab 2016;7:136-47] A vancomycin level drawn before the scheduled time may actually be subtherapeutic, potentially resulting in undertreating the infection. This may ultimately lead to increased antimicrobial resistance, which has been associated with an increased cost of $18,588 to $29,069 per patient, and increase in length of stay of 6.4 to 12.7 days, and an increase in mortality of 6.5%.^[Roberts R, et al. Clin Infect Dis 2009;49:1175-84]

# Pre-Intervention Data Analysis

```{r, fig.cap="Orders for Early AM or by Vancomycin Request"}
left_join(requests, early_am, by = "order.unit") %>%
    gather(key, value, requests, early_am) %>%
    ggplot(aes(x = order.unit, y = value)) +
    geom_bar(aes(fill = key), stat = "identity", position = "dodge") +
    xlab("Unit") +
    ylab("Levels (N)") + 
    scale_fill_brewer(palette = "Paired", labels = c("Early AM", "Request"), guide = guide_legend(title = NULL)) +
    theme_bw() +
    theme(legend.position = "bottom", axis.text.x = element_text(angle = 45, hjust = 1))
```

Vancomycin level requests are excluded from the analysis of appropriate collection. Vancomycin levels ordered as Early AM are considered appropriate if they are drawn at 0300 plus/minus 120 minutes.

```{r, fig.cap="Inappropriate Levels by Hour of Day"}
cvicu %>%
    filter(!appropriate) %>%
    ggplot(aes(x = hour)) +
    geom_bar() +
    xlab("Hour of Day") +
    ylab("Levels (N)") +
    theme_bw() +
    coord_cartesian(xlim = c(0, 24)) +
    scale_x_continuous(breaks = seq(0, 24, 6))
```


```{r, fig.cap="Uncollected Levels by Hour of Day"}
cvicu %>%
    filter(uncollected) %>%
    ggplot(aes(x = hour)) +
    geom_bar() +
    xlab("Hour of Day") +
    ylab("Levels (N)") +
    theme_bw() +
    coord_cartesian(xlim = c(0, 24)) +
    scale_x_continuous(breaks = seq(0, 24, 6))
```
