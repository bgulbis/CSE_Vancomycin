---
title: "Analysis of Vancomycin Dispatch Times"
author: "Brian Gulbis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  tint::tintHtml:
    self_contained: yes
link-citations: yes
---

```{r setup, include=FALSE}
library(tint)
# invalidate cache when the package version changes
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tint'), echo = FALSE, warning = FALSE)
options(htmltools.dir.version = FALSE)
```

```{r, message=FALSE}
library(tidyverse)
library(stringr)
library(forcats)
library(lubridate)
library(broom)
library(plotly)
library(qicharts)

x <- dirr::get_rds("../data/tidy")

end_date <- "2017-03-05"

hvi <- c("HH CVICU", "HH CVIMU", "HH HFIC", "HH HFIM", "HH 5HVI", "HH CCU", "HVI CIMU")

orders_levels <- full_join(vanc_levels, orders_valid, by = c("pie.id", "order.id")) %>%
    filter(event.unit %in% hvi | (is.na(event.unit) & order.unit %in% hvi)) %>%
    mutate(not_collected = is.na(Collected) & is.na(lab.result),
           location = coalesce(event.unit, order.unit),
           month = floor_date(detail.datetime, unit = "month"),
           week = floor_date(detail.datetime, unit = "week"),
           day = wday(detail.datetime, label = TRUE, abbr = TRUE),
           hour = hour(detail.datetime),
           day_order = wday(order.datetime, label = TRUE, abbr = TRUE),
           hour_order = hour(order.datetime),
           exceed_2hr = abs(collect_detail_diff) > 120,
           pilot = detail.datetime >= mdy("1/30/2017", tz = "US/Central"),
           future_order = order_detail_diff > 1) %>%
    dmap_at(c("timely120", "timely60", "appropriate"), ~ coalesce(.x, FALSE))
```

```{r, eval=FALSE}
write_csv(orders_levels, "../data/external/vancomycin_orders_levels.csv")

orders_levels_summary <- select(orders_levels, pie.id, order.id, event.unit, order.unit, priority, order.datetime, detail.datetime, dispatch.datetime = Dispatched, collected.datetime = Collected, order_detail_diff, order_dispatch_diff, dispatch_detail_diff, collect_detail_minutes = collect_detail_diff, timely = timely60, shift, day, hour, pilot, future_order)

write_csv(orders_levels_summary, "../data/external/vancomycin_orders_levels_key_variables.csv")
```

```{r data_sets}
data_orders <- orders_levels %>%
    filter(priority %in% c("Routine", "Stat", "Timed Study"),
           detail.datetime >= order.datetime - hours(1))

data_orders_backdated <- orders_levels %>%
    filter(priority %in% c("Routine", "Stat", "Timed Study"),
           detail.datetime < order.datetime - hours(1))

data_orders_72hr_cutoff <- orders_levels %>%
    filter(priority %in% c("Routine", "Stat", "Timed Study"),
           detail.datetime >= order.datetime,
           order_dispatch_diff <= 72) 
```

```{r}
theme_bg <- function(base_size = 11, base_family = "") {
    theme_bw(base_family = base_family, base_size = base_size) +
        theme(legend.background = element_blank(), 
              legend.key = element_blank(), 
              legend.text = element_text(color = "grey35"),
              panel.background = element_blank(), 
              panel.border = element_blank(), 
              strip.background = element_blank(), 
              plot.background = element_blank(), 
              panel.grid = element_blank(),
              axis.line = element_line(color = "grey85"),
              axis.text = element_text(color = "grey35"),
              axis.title = element_text(color = "grey35"),
              axis.ticks = element_line(color = "grey35"))
}
```

# Distribution

In all of the following figures, values where the scheduled collection time occured > 1 hour prior to the order time were removed (n = `r nrow(data_orders_backdated)`). It is unclear exactly why the the scheduled collection time for these orders was back-dated to be prior to the time of ordering. 

```{r, fig.cap="Histogram of difference between dispatch time and scheduled collection time"}
plot_ly(data_orders, split = ~priority) %>%
    add_histogram(x = ~dispatch_detail_diff) %>%
    layout(xaxis = list(title = "Time (Hours)", tickvals = seq(-24, 48, 6)), yaxis = list(title = "Count"))
```

It is clear that Stat orders dispatch immediately, but Routine and Timed Study are much more variable, with most dispatching 1-3 hours before the scheduled collection time.

```{r, fig.cap="Distribution of the difference between dispatch time and scheduled collection time in all HVI units"}
plot_ly(data_orders) %>%
    add_boxplot(x = ~priority, y = ~dispatch_detail_diff) %>%
    layout(xaxis = list(title = "Collection Priority"), yaxis = list(title = "Time (Hours)", tickvals = seq(-24, 48, 6)))
```

```{r}
summary(data_orders$dispatch_detail_diff) %>%
    tidy() %>%
    knitr::kable(caption = "Summary measures for the time from dispatch to scheduled collection")
```

```{r}
data_orders %>%
    group_by(priority) %>%
    do(tidy(summary(.$dispatch_detail_diff))) %>%
    knitr::kable(caption = "Summary measures for the time from dispatch to scheduled collection by collection priority")
```

```{r, fig.cap="Distribution of dispatch time by day of week. Based on the day of week for the scheduled collection time."}
plot_ly(data_orders, split = ~priority) %>%
    add_boxplot(x = ~day, y = ~dispatch_detail_diff) %>%
    # add_boxplot(x = ~day_order, y = ~dispatch_detail_diff, name = "Order Day") %>%
    layout(boxmode = "group", xaxis = list(title = "Day of Week"), yaxis = list(title = "Time (Hours)", tickvals = seq(-24, 48, 6)))
```

```{r, fig.cap="Distribution of dispatch time by hour of day. Based on the hour of day for the scheduled collection time."}
plot_ly(data_orders, split = ~priority) %>%
    add_boxplot(x = ~hour, y = ~dispatch_detail_diff) %>%
    # add_boxplot(x = ~hour_order, y = ~dispatch_detail_diff, name = "Order Day") %>%
    layout(boxmode = "group", xaxis = list(title = "Hour of Day", tickvals = seq(0, 23, 2)), yaxis = list(title = "Time (Hours)", tickvals = seq(-24, 48, 6)))
```

Labs ordered > 72 hours in advance of collection were removed. 

```{r, fig.cap="Histogram of difference between order time and dispatch time"}
plot_ly(data_orders_72hr_cutoff, split = ~priority) %>%
    add_histogram(x = ~order_dispatch_diff) %>%
    layout(xaxis = list(title = "Time (Hours)", tickvals = seq(-24, 72, 6)), yaxis = list(title = "Count"))
```

```{r, fig.cap="Distribution of difference between order time and dispatch time"}
plot_ly(data_orders_72hr_cutoff) %>%
    add_boxplot(x = ~priority, y = ~order_dispatch_diff) %>%
    layout(xaxis = list(title = "Collection Priority"), yaxis = list(title = "Time (Hours)", tickvals = seq(-24, 72, 6)))
```

# Correlation Assessment

```{r, fig.cap="Time between order to scheduled collection and order to dispatch. Data with order to scheduled collection of > 72 hours were removed. Values where the scheduled collection time was prior to the order time were removed."}
plot_ly(data_orders_72hr_cutoff) %>%
    add_markers(x = ~order_detail_diff, y = ~order_dispatch_diff, color = ~priority, marker = list(symbol = "circle-open")) %>%
    layout(xaxis = list(title = "Collection Time (hours)", tickvals = seq(0, 72, 12)), yaxis = list(title = "Dispatch Time (hours)", tickvals = seq(0, 72, 12)))
```

There is a strong correlation between the time from order to scheduled collection and the time from order to dispatch.

```{r}
cor.test(~ order_detail_diff + order_dispatch_diff, data_orders_72hr_cutoff) %>%
    tidy() %>%
    knitr::kable(digits = 3, caption = "Correlation between the time from order to scheduled collection and the time from order to dispatch")
```

```{r, fig.cap="Time between order to scheduled collection and dispatch to scheduled collection"}
plot_ly(data_orders_72hr_cutoff) %>%
    add_markers(x = ~order_detail_diff, y = ~dispatch_detail_diff, color = ~priority, marker = list(symbol = "circle-open")) %>%
    layout(xaxis = list(title = "Order Time (hours)", tickvals = seq(0, 72, 12)), yaxis = list(title = "Dispatch Time (hours)", tickvals = seq(0, 72, 6)))
```

There is little correlation between the time from order to scheduled collection and time from dispatch to scheduled collection. This suggests that the dispatch time is triggered by the scheduled collection time, regardless of how far in advance the lab is ordered, with the exception of Stat orders which dispatch immediately.

```{r}
cor.test(~ order_detail_diff + dispatch_detail_diff, data_orders_72hr_cutoff) %>%
    tidy() %>%
    knitr::kable(digits = 3, caption = "Correlation between the time from order to scheduled collection and time from dispatch to scheduled collection")
```

```{r, fig.cap="Time between dispatch to scheduled collection and scheduled to actual collection"}
plot_ly(data_orders_72hr_cutoff) %>%
    add_markers(x = ~dispatch_detail_diff, y = ~collect_detail_diff / 60, color = ~priority, marker = list(symbol = "circle-open")) %>%
    layout(xaxis = list(title = "Dispatch Time (hours)", tickvals = seq(0, 72, 12)), yaxis = list(title = "Scheduled to Actual Collection (hours)", tickvals = seq(-48, 120, 12)))
```

There is no correlation between the amount of time prior to scheduled collection that the task dispatched and when the lab was actually collected.

```{r}
cor.test(~ dispatch_detail_diff + collect_detail_diff, data_orders_72hr_cutoff) %>%
    tidy() %>%
    knitr::kable(digits = 3, caption = "Correlation between the amount of time prior to scheduled collection that the task dispatched and when the lab was actually collected")
```

# Actual Timed Studies

```{r, fig.cap="Time between dispatch to scheduled collection and scheduled to actual collection for actual timed studies. This was defined as labs scheduled for collection at least 1 hour after the time of ordering."}
data_orders_72hr_cutoff %>%
    filter(future_order) %>%
    plot_ly() %>%
    add_markers(x = ~dispatch_detail_diff, y = ~collect_detail_diff / 60, color = ~priority, marker = list(symbol = "circle-open")) %>%
    layout(xaxis = list(title = "Dispatch Time (hours)", tickvals = seq(0, 72, 12)), yaxis = list(title = "Scheduled to Actual Collection (hours)", tickvals = seq(-48, 120, 12)))
```

# Back-Dated Orders

```{r}
data_orders_backdated %>%
    dmap_at("action.provider.role", fct_infreq) %>%
    count(action.provider.role) %>%
    plot_ly() %>%
    add_bars(x = ~n, y = ~action.provider.role, orientation = "h") %>%
    layout(yaxis = list(title = ""), margin = list(l = 240))
```

```{r}
data_orders_backdated %>%
    dmap_at("action.comm", fct_infreq) %>%
    count(action.comm) %>%
    plot_ly() %>%
    add_bars(y = ~n, x = ~action.comm) %>%
    layout(xaxis = list(title = "Order Type"), yaxis = list(title = "Count"))
```

# Control Charts

```{r, fig.cap="Time from dispatch until scheduled collection"}
data_orders %>%
    filter(priority == "Timed Study") %>%
    dmap_at("dispatch_detail_diff", ~ .x * 60) %>%
    qic(y = dispatch_detail_diff, data = ., chart = "i")
```

# Future Orders

```{r eval=FALSE}
# use this to identify specific individuals who placed the orders

library(edwr)
x <- data_orders %>%
    filter(priority == "Routine",
           future_order) 

y <- data_orders %>%
    filter(priority == "Timed Study",
           !future_order)

order_actions <- read_data("../data/raw", "action") %>%
    as.order_action() 

future_routine <- order_actions %>%
    semi_join(x, by = "order.id") %>%
    filter(action.type == "Order",
           action.provider != "SYSTEM") %>%
    select(order.id, action.provider, action.provider.role, action.comm) %>%
    count(action.provider)

now_timed <- order_actions %>%
    semi_join(y, by = "order.id") %>%
    filter(action.type == "Order",
           action.provider != "SYSTEM") %>%
    select(order.id, action.provider, action.provider.role, action.comm) %>%
    count(action.provider)

```

```{r, fig.cap="Percent of orders for future labs by each order priority. Future labs considered those > 1 hour from the time of ordering."}
data_orders %>%
    # filter(order.unit == "HH CVICU") %>%
    group_by(priority) %>%
    summarize_at("future_order", mean) %>%
    plot_ly() %>%
    add_bars(x = ~priority, y = ~future_order * 100) %>%
    layout(xaxis = list(title = "Order Priority"), yaxis = list(title = "Count"))
```

```{r, fig.cap="Provider role placing future orders using Routine or Stat"}
# who is placing future orders using routine / stat
data_orders %>%
    filter(priority %in% c("Routine", "Stat"),
           future_order) %>%
    dmap_at("action.provider.role", fct_infreq) %>%
    dmap_at("action.provider.role", fct_lump, n = 10) %>%
    count(action.provider.role) %>%
    plot_ly() %>%
    add_bars(x = ~n, y = ~action.provider.role, orientation = "h") %>%
    layout(yaxis = list(title = ""), margin = list(l = 240))
```

```{r, fig.cap="Provider role placing Now orders using Timed Study"}
# who is placing orders for now using timed study
data_orders %>%
    filter(priority == "Timed Study",
           !future_order) %>%
    dmap_at("action.provider.role", fct_infreq) %>%
    dmap_at("action.provider.role", fct_lump, n = 10) %>%
    count(action.provider.role) %>%
    plot_ly() %>%
    add_bars(x = ~n, y = ~action.provider.role, orientation = "h") %>%
    layout(yaxis = list(title = ""), margin = list(l = 240))
```
