---
title: "Figures for Graduation Presentation"
author: "Brian Gulbis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    code_folding: hide
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(tidyverse)
library(stringr)
library(forcats)
library(lubridate)
library(broom)
library(qicharts)
library(themebg)

x <- dirr::get_rds("../data/tidy")

end_date <- "2017-03-05"
baseline <- "2016-12-31"

hvi <- c("HH CVICU", "HH CVIMU", "HH HFIC", "HH HFIM", "HH 5HVI", "HH CCU", "HVI CIMU")
# hvi <- "HH CVICU"

orders_levels <- full_join(vanc_levels, orders_valid, by = c("pie.id", "order.id")) %>%
    filter(event.unit %in% hvi | (is.na(event.unit) & order.unit %in% hvi)) %>%
    mutate(not_collected = is.na(Collected) & is.na(lab.result),
           location = coalesce(event.unit, order.unit),
           month = floor_date(detail.datetime, unit = "month"),
           week = floor_date(detail.datetime, unit = "week"),
           day = wday(detail.datetime, label = TRUE, abbr = TRUE),
           hour = hour(detail.datetime),
           day_order = wday(order.datetime, label = TRUE, abbr = TRUE),
           hour_order = hour(order.datetime),
           exceed_2hr = abs(collect_detail_diff) > 120,
           pilot = detail.datetime >= mdy("1/30/2017", tz = "US/Central"),
           future_order = order_detail_diff > 1) %>%
    dmap_at(c("timely120", "timely60", "appropriate"), ~ coalesce(.x, FALSE)) %>%
    dmap_at("future_order", ~if_else(.x, "Future", "Now"))

collected <- orders_levels %>%
    filter(!is.na(Collected),
           order.datetime <= ymd(baseline)) %>%
    group_by(event.unit) %>%
    summarize(collected = n(),
              timely = sum(appropriate, na.rm = TRUE),
              early = sum(early, na.rm = TRUE),
              late = sum(late, na.rm = TRUE),
              late_2hr = sum(exceed_2hr, na.rm = TRUE)) 

not_done <- orders_levels %>%
    filter(is.na(Collected),
           is.na(lab.result),
           order.datetime <= ymd(baseline)) %>%
    group_by(order.unit) %>%
    count %>%
    rename(not_done = n)

requests <- orders_requests %>%
    filter(order.datetime <= ymd(baseline)) %>%
    group_by(order.unit) %>%
    count %>%
    rename(requests = n) %>%
    filter(order.unit %in% hvi)

early_am <- orders_early_am %>%
    filter(order.datetime <= ymd(baseline)) %>%
    group_by(order.unit) %>%
    count() %>%
    rename(early_am = n) %>%
    filter(order.unit %in% hvi) 

# percent_timely = timely / collected,
           
totals_units <- left_join(collected, not_done, by = c("event.unit" = "order.unit")) %>%
    left_join(requests, by = c("event.unit" = "order.unit")) %>%
    left_join(early_am, by = c("event.unit" = "order.unit")) %>%
    mutate(total = collected + not_done,
           defects = total - timely,
           percent_not_done = not_done / total,
           percent_appropriate = timely / total,
           percent_exceed_2hr = late_2hr / total,
           percent_requests = requests / total,
           percent_early_am = early_am / total)

totals_hvi <- totals_units %>%
    ungroup() %>%
    summarize_at(vars(collected, timely, early, late, late_2hr, not_done, requests, early_am, total, defects), funs(sum), na.rm = TRUE) %>%
    mutate(event.unit = "HVI",
           percent_not_done = not_done / total,
           percent_appropriate = timely / total,
           percent_exceed_2hr = late_2hr / total,
           percent_requests = requests / total,
           percent_early_am = early_am / total) 

totals <- bind_rows(totals_units, totals_hvi) %>%
    select(event.unit, num_levels = total, everything()) %>%
    filter(!is.na(event.unit))

```

```{r, fig.cap="Timeliness and types of orders for vancomycin levels placed during the baseline period of April - to December 2016."}
totals %>%
    filter(event.unit == "HH CVICU") %>%
    select(starts_with("percent"), -percent_exceed_2hr) %>%
    gather(nm, val) %>%
    dmap_at("val", ~ round(.x * 100, 0)) %>%
    arrange(desc(val)) %>%
    dmap_at("nm", fct_inorder) %>%
    ggplot(aes(x = nm, y = val)) +
    geom_bar(stat = "identity", width = 0.75) +
    scale_x_discrete("", labels = c("Timely", "Early AM", "Requests", "Uncollected")) +
    ylab("Vancomycin Level Orders (%)") +
    coord_cartesian(ylim = c(0, 100)) +
    theme_bg(xticks = FALSE)
```

